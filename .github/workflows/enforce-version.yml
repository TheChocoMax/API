---
name: Enforce Correct Version Update

permissions:
  contents: read
  statuses: read

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.py'
      - '!**/tests/**'

jobs:
  detect-changed-versions:
    uses: ./.github/workflows/detect-changed-versions.yml

  check-version:
    name: Check __version__ Changes
    needs: detect-changed-versions
    runs-on: ubuntu-latest
    if: needs.detect-changed-versions.outputs.versions != ''
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check __version__ change for each version
        run: |
          git fetch origin main
          BASE_SHA=$(git merge-base HEAD origin/main)
          for v in ${{ needs.detect-changed-versions.outputs.versions }}; do
            VERSION_CHANGED=$(git diff "$BASE_SHA"...HEAD -- "routes/$v/__init__.py" | grep '__version__ = ' || true)
            if [ -z "$VERSION_CHANGED" ]; then
              echo "ðŸ›‘ Version $v changed, but __version__ not updated."
              exit 1
            else
              echo "âœ… $v version updated."
            fi
          done
